# 产品功能完善方案

## 问题分析

### 1. 排序功能

**当前状态：**
- 固定按日期降序排序（最新的在前）
- 代码位置：`JournalView.ts:422`

**方案设计：**

#### 1.1 排序选项
提供以下排序方式：
- **按日期**（默认）
  - 降序（最新的在前）✓ 当前默认
  - 升序（最旧的在前）
- **按标题**（字母顺序）
  - A-Z
  - Z-A
- **按字数**
  - 从多到少
  - 从少到多
- **按创建时间**
  - 最新的在前
  - 最旧的在前

#### 1.2 配置方式
**方案A：视图内工具栏（推荐）**
- 在视图头部添加排序下拉菜单
- 优点：直观，用户可随时切换
- 缺点：占用UI空间

**方案B：设置页面**
- 在插件设置中添加排序选项
- 优点：不占用视图空间
- 缺点：需要进入设置页面修改

**方案C：两者结合（最佳）**
- 设置页面：设置默认排序方式
- 视图工具栏：提供快速切换按钮
- 当前排序状态显示在工具栏

**推荐：方案C**

---

### 2. 目录绑定

**当前状态：**
- 文件夹右键菜单：创建文件夹手记视图
- 设置页面：`folderPath`（全局设置）
- 支持：`folderJournalViews`（多个文件夹映射）

**方案设计：**

#### 2.1 使用场景分析
1. **单一日记目录**（最常见）
   - 用户有一个专门的日记文件夹
   - 希望打开视图时自动扫描该文件夹

2. **多个日记目录**
   - 用户可能有多个日记文件夹（如：工作日记、个人日记）
   - 需要支持切换不同文件夹

3. **整个Vault**
   - 用户希望扫描所有Markdown文件

#### 2.2 配置方式

**方案A：视图内选择器（推荐）**
- 在视图头部添加文件夹选择下拉菜单
- 显示当前绑定的文件夹
- 支持切换不同文件夹
- 支持"扫描整个Vault"选项
- 支持添加/移除文件夹

**方案B：设置页面配置**
- 在设置页面管理文件夹列表
- 优点：集中管理
- 缺点：不够直观

**方案C：两者结合（最佳）**
- 设置页面：管理文件夹列表（添加/删除）
- 视图工具栏：快速切换当前文件夹
- 首次使用：引导用户选择文件夹

**推荐：方案C**

#### 2.3 实现细节
- 支持多个文件夹配置
- 每个视图实例可以绑定不同文件夹
- 支持文件夹路径自动检测（如果只有一个Markdown文件夹，自动绑定）
- 支持文件夹重命名/移动后的自动更新

---

### 3. 自动刷新

**当前状态：**
- 需要手动点击刷新按钮或使用命令
- 代码位置：`main.ts:40-48`

**方案设计：**

#### 3.1 刷新触发场景
1. **文件创建**：新建Markdown文件
2. **文件修改**：编辑现有文件（内容、frontmatter）
3. **文件删除**：删除文件
4. **文件重命名**：文件或文件夹重命名
5. **文件夹变化**：文件夹内文件变化

#### 3.2 实现方式

**方案A：实时监听（推荐）**
- 使用 Obsidian 的 `vault.on('modify')` 等事件
- 监听绑定文件夹内的文件变化
- 自动刷新视图
- 优点：实时更新
- 缺点：可能频繁刷新（需要防抖）

**方案B：定时刷新**
- 每N秒检查一次文件变化
- 优点：简单
- 缺点：不够实时，可能浪费资源

**方案C：智能刷新（最佳）**
- 实时监听文件变化
- 使用防抖（debounce）避免频繁刷新
- 仅在视图可见时刷新
- 提供开关：用户可选择开启/关闭自动刷新

**推荐：方案C**

#### 3.3 防抖策略
- 文件变化后等待 500ms 再刷新（避免连续修改导致频繁刷新）
- 如果视图不在前台，延迟刷新直到视图激活
- 提供手动刷新按钮作为备选

---

## 实施优先级

### Phase 1: 核心功能（高优先级）
1. ✅ **排序功能**
   - 添加排序选项到设置页面
   - 实现多种排序方式
   - 在视图工具栏添加排序切换

2. ✅ **目录绑定优化**
   - 优化文件夹选择UI
   - 支持视图内切换文件夹
   - 改进首次使用体验

### Phase 2: 增强功能（中优先级）
3. ✅ **自动刷新**
   - 实现文件变化监听
   - 添加防抖机制
   - 提供自动刷新开关

### Phase 3: 优化体验（低优先级）
4. 性能优化
5. 错误处理
6. 用户引导

---

## 技术实现要点

### 1. 排序功能
```typescript
interface SortOption {
  field: 'date' | 'title' | 'wordCount' | 'created';
  order: 'asc' | 'desc';
}

// 在 JournalView 中添加
private sortEntries(entries: JournalEntry[], option: SortOption): JournalEntry[]
```

### 2. 目录绑定
```typescript
interface JournalPluginSettings {
  // ...现有设置
  defaultFolderPath: string | null; // 默认文件夹
  folderList: string[]; // 文件夹列表
  currentFolderPath: string | null; // 当前视图绑定的文件夹
}
```

### 3. 自动刷新
```typescript
// 在 JournalView 中
private setupAutoRefresh(): void {
  // 监听文件变化
  this.registerEvent(
    this.app.vault.on('modify', debounce(() => {
      if (this.isVisible) {
        this.refresh();
      }
    }, 500))
  );
}
```

---

## 用户界面设计

### 视图头部工具栏
```
[手记] [📁 日记/ ▼] [🔄 排序: 日期 ▼] [⚙️ 设置]
```

### 设置页面
```
手记视图设置
├── 默认文件夹
│   └── [选择文件夹] [添加文件夹]
├── 排序设置
│   ├── 默认排序方式: [日期 ▼]
│   └── 排序顺序: [降序 ▼]
└── 自动刷新
    ├── [✓] 启用自动刷新
    └── 刷新延迟: [500ms]
```

---

## 待确认问题

1. **排序默认值**：是否保持"日期降序"作为默认？
2. **多文件夹支持**：是否需要支持同时显示多个文件夹的内容？
3. **自动刷新范围**：是否只刷新当前绑定的文件夹，还是整个Vault？
4. **性能考虑**：大文件夹（1000+文件）的自动刷新性能如何保证？
